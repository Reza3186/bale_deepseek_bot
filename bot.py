import requests
import time
import os
import threading
from flask import Flask

# âš ï¸ Ú©Ù„ÛŒØ¯Ù‡Ø§ Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
BALE_TOKEN = os.environ.get('BALE_TOKEN')
OPENROUTER_API_KEY = os.environ.get('OPENROUTER_API_KEY')

# Ø§Ú¯Ø± Ú©Ù„ÛŒØ¯Ù‡Ø§ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯ØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…ØªÙˆÙ‚Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.
if not BALE_TOKEN or not OPENROUTER_API_KEY:
    print("âŒ Ø®Ø·Ø§ÛŒ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ: BALE_TOKEN ÛŒØ§ OPENROUTER_API_KEY Ø¯Ø± Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.")
    # Ø¯Ø± Ù…Ø­ÛŒØ· ÙˆØ§Ù‚Ø¹ÛŒØŒ Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø®Ø·Ø§ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯. Ø§Ù…Ø§ Ø¨Ø±Ø§ÛŒ ØªØ³ØªØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù† ÛŒÚ© Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ú¯Ø°Ø§Ø´Øª.
    # Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ØŒ ØªØ±Ø¬ÛŒØ­ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…ØªÙˆÙ‚Ù Ø´ÙˆØ¯ ØªØ§ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯Ø± Render ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒÙ….
    exit(1)

# ğŸ”— API URLs
BALE_BASE = f"https://tapi.bale.ai/bot{BALE_TOKEN}"
DEEPSEEK_URL = "https://openrouter.ai/api/v1/chat/completions"

# ğŸŒ Flask app Ùˆ Ù…ØªØºÛŒØ± Ø¬Ù‡Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª
app = Flask(__name__)
last_update_id = 0

@app.route("/")
def home():
    """Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø±Ø¨Ø§Øª"""
    return "ğŸ¤– Bale + GPT-3.5-Turbo Bot is Running (Ready for Deployment)"

# ğŸ’¬ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ù…Ø¯Ù„ OpenRouter
def ask_deepseek(user_text: str) -> str:
    """Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ† Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù…Ø¯Ù„ GPT-3.5-Turbo Ø§Ø² Ø·Ø±ÛŒÙ‚ OpenRouter"""
    headers = {
        "Authorization": f"Bearer {OPENROUTER_API_KEY}",
        "Content-Type": "application/json"
    }
    payload = {
        "model": "openai/gpt-3.5-turbo",
        "messages": [{"role": "user", "content": user_text}],
        "temperature": 0.7
    }
    try:
        resp = requests.post(DEEPSEEK_URL, headers=headers, json=payload, timeout=45)
        resp.raise_for_status() 
        data = resp.json()

        if "choices" in data and data["choices"]:
            return data["choices"][0]["message"]["content"].strip()

        error_message = data.get('error', {}).get('message', 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯Ø± Ù¾Ø§Ø³Ø® Ù…Ø¯Ù„')
        return f"âŒ Ø®Ø·Ø§ÛŒ Ù¾Ø§Ø³Ø® Ù…Ø¯Ù„: {error_message}"

    except requests.exceptions.HTTPError as e:
        return f"âŒ Ø®Ø·Ø§ÛŒ HTTP Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ OpenRouter: {e}. (Ú©Ù„ÛŒØ¯ OpenRouter Ø±Ø§ Ø¯Ø± Render Ú†Ú© Ú©Ù†ÛŒØ¯)"
    except requests.exceptions.RequestException as e:
        return f"âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: {e}"
    except Exception as e:
        return f"âŒ Ø®Ø·Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø§Ø³Ø®: {e}"

# ğŸ“¥ Ú¯Ø±ÙØªÙ† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø¨Ù„Ù‡
def get_updates(offset: int | None) -> dict:
    """Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù¾Ø¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø² API Ø¨Ù„Ù‡"""
    params = {'offset': offset} if offset else {}
    try:
        res = requests.get(f"{BALE_BASE}/getUpdates", params=params, timeout=15)
        res.raise_for_status()
        return res.json()
    except requests.exceptions.RequestException as e:
        print(f"âŒ Ø®Ø·Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª getUpdates Ø§Ø² Ø¨Ù„Ù‡: {e}")
        return {}

# ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
def send_message(chat_id: int, reply_text: str):
    """Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¨Ù„Ù‡"""
    payload = {'chat_id': chat_id, 'text': reply_text}
    try:
        requests.post(f"{BALE_BASE}/sendMessage", json=payload, timeout=10)
    except requests.exceptions.RequestException as e:
        print(f"âŒ Ø®Ø·Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú†Øª {chat_id}: {e}")

# ğŸ¤– ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª Ø¨Ø§ polling
def run_bot():
    """Ø­Ù„Ù‚Ù‡ Ø§ØµÙ„ÛŒ Polling Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§"""
    global last_update_id
    print("âœ… Ø±Ø¨Ø§Øª Ø¨Ù„Ù‡ + OpenRouter ÙØ¹Ø§Ù„ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§...")

    while True:
        try:
            updates = get_updates(last_update_id)
            
            for upd in updates.get("result", []):
                message = upd.get("message", {})
                chat_id = message.get("chat", {}).get("id")
                text = message.get("text")
                
                if chat_id and text:
                    print(f"[{chat_id}] ğŸ“© Ù¾ÛŒØ§Ù… Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯: {text}")
                    reply = ask_deepseek(text)
                    print(f"[{chat_id}] ğŸ“¨ Ù¾Ø§Ø³Ø® Ø¢Ù…Ø§Ø¯Ù‡: {reply[:50]}...")
                    send_message(chat_id, reply)
                    
                current_update_id = upd.get("update_id", 0)
                if current_update_id >= last_update_id:
                     last_update_id = current_update_id + 1
            
            time.sleep(1)

        except Exception as e:
            print(f"ğŸ›‘ Ø®Ø·Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ Ø¯Ø± Ø­Ù„Ù‚Ù‡ Ø§ØµÙ„ÛŒ: {e}")
            time.sleep(5)

# ğŸ’¡ Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø§Øª Ø¯Ø± ØªØ±Ø¯ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡
def start_polling():
    """Ø´Ø±ÙˆØ¹ Ø­Ù„Ù‚Ù‡ Polling Ø¯Ø± ÛŒÚ© Thread Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡"""
    threading.Thread(target=run_bot, daemon=True).start()

# ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ Flask Server
if __name__ == "__main__":
    start_polling()
    # Ù¾ÙˆØ±Øª 10000 ÛŒØ§ 5000 Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ·â€ŒÙ‡Ø§ÛŒ Ø§Ø¨Ø±ÛŒ Ø±Ø§ÛŒØ¬ Ø§Ø³Øª.
    port = int(os.environ.get("PORT", 10000))
    print(f"ğŸŒ Ø³Ø±ÙˆØ± Flask Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø¨Ø± Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª {port}...")
    app.run(host="0.0.0.0", port=port)
